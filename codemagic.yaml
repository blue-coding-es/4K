workflows:
  default-workflow:
    name: Flutter CI
    max_build_duration: 30          # minutos
    environment:
      flutter: stable               # Canal Â«stableÂ» preinstalado en Codemagic
      xcode: latest                 # Xcode 16 (SDK iOS 18)

   scripts:
  - name: Ensure Flutter project structure
    script: |
      if [ ! -d "android" ]; then
        echo "Generating missing native foldersâ€¦"
        flutter create . --platforms=android,ios,web
      fi
      # Elimina test de plantilla
      if [ -f "test/widget_test.dart" ]; then
        rm test/widget_test.dart
      fi
      # ðŸ©¹ Parchear packagingOptions en build.gradle
      GRADLE_FILE="android/app/build.gradle"
      if ! grep -q "pickFirst \"lib/**/libc++_shared.so\"" "$GRADLE_FILE"; then
        echo "Patching packagingOptionsâ€¦"
        # Inserta lÃ­neas justo despuÃ©s de 'android {' bloque
        sed -i.bak '/android {/a \
    packagingOptions {\n        pickFirst "lib/**/libc++_shared.so"\n    }' "$GRADLE_FILE"
      fi
  - flutter pub get
  - flutter clean
  - flutter analyze
  - flutter test
  - flutter build apk --release -v
  # - flutter build ios --release --no-codesign   # reactiva cuando APK pase

    artifacts:
      # Archivos de salida que Codemagic mostrarÃ¡ para descargar
      - build/**/outputs/**/*.apk
      - build/ios/ipa/*.ipa
    # Opcional: dispara automÃ¡ticamente en cada push a main
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "main"
          include: true
